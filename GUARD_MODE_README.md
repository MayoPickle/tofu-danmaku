# 保卫模式功能说明

## 功能概述

保卫模式是一个新增的PK自动应对功能，当用户激活豆豆并说出特定关键词时，系统会在下一场PK中自动发送比对方多2票的礼物。

## 激活条件

1. **必须先激活豆豆**：弹幕中必须包含"豆豆"关键词
2. **说出保卫关键词**：弹幕中必须包含以下关键词之一：
   - "前进一"
   - "前进二" 
   - "前进三"
   - "前进四"

## 工作流程

### 1. 激活阶段
- 用户发送包含"豆豆"和保卫关键词的弹幕（如："豆豆前进一"）
- 系统检测到关键词后激活保卫模式
- 同时将关键词信息发送给`guard_mode`接口

### 2. PK执行阶段
- 保卫模式在下一场PK中生效
- 在PK结束时，系统会：
  - 获取双方的票数信息
  - 计算目标票数：对方票数 + 2票
  - 调用`pk_wanzun`接口，发送保卫模式数据

### 3. 自动关闭
- PK结束后，保卫模式自动关闭
- 下次需要重新激活

## 示例场景

假设PK情况：
- 对方：24票
- 己方：20票
- 保卫模式激活关键词："前进一"

系统会自动发送26票（24 + 2）的礼物。

## API接口

### 1. guard_mode接口
当检测到保卫模式关键词时调用：
```json
{
    "room_id": 12345,
    "danmaku": "豆豆前进一",
    "guard_keyword": "前进一"
}
```

### 2. pk_wanzun接口（保卫模式）
PK结束时调用，包含保卫模式标识：
```json
{
    "room_id": 12345,
    "battle_type": 1,
    "pk_data": {...},
    "token": "8096",
    "guard_mode": true,
    "target_votes": 26,
    "activated_keyword": "前进一"
}
```

## 配置参数

在`src/config.py`中可以配置：

```python
# 保卫模式激活关键词列表
GUARD_MODE_KEYWORDS = ["前进一", "前进二", "前进三", "前进四"]

# 保卫模式票数差值（比对方多送的票数）
GUARD_MODE_VOTE_DIFFERENCE = 2
```

## 日志输出

系统会输出详细的日志信息：

```
🛡️ 保卫模式已激活，触发关键词：'前进一'，完整消息：'豆豆前进一'
✅ 保卫模式关键词已发送至接口：'前进一'
🛡️ 保卫模式激活中，触发关键词：'前进一'
🎯 保卫模式目标：对方24票，将发送26票
🛡️ 保卫模式API调用成功：目标票数=26，关键词='前进一'
🛡️ 保卫模式已关闭，之前的触发关键词：'前进一'
```

## 注意事项

1. **单次激活**：保卫模式一次只能激活一个关键词，重复激活会被忽略
2. **自动关闭**：PK结束后自动关闭，需要重新激活
3. **依赖豆豆**：必须先激活豆豆才能触发保卫模式
4. **线程安全**：使用锁机制确保多线程环境下的安全性

## 测试

可以运行测试脚本验证功能：

```bash
python test_guard_mode.py
```

测试脚本会模拟完整的保卫模式流程，包括激活、PK处理和自动关闭。 